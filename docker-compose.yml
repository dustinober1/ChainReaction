# ChainReaction Docker Compose Configuration
# Run: docker compose up --build
# Stop: docker compose down

services:
  # ============================================
  # Backend API Service (FastAPI/Python)
  # ============================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: chainreaction-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=production
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - LOG_LEVEL=INFO
      - SECRET_KEY=${SECRET_KEY:-changeme-in-production}
      - API_KEY=${API_KEY:-dev-api-key-12345}
      # Neo4j Connection
      - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
      - NEO4J_USERNAME=${NEO4J_USERNAME:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-password}
      # LLM Configuration
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4-turbo-preview}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen3:1.7b}
      # External APIs
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
      - NEWS_API_KEY=${NEWS_API_KEY:-}
    volumes:
      - ./data:/app/data:rw
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - chainreaction-network
    depends_on:
      neo4j:
        condition: service_healthy

  # ============================================
  # Frontend Service (Next.js)
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=http://localhost:8000
    container_name: chainreaction-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend:8000
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - chainreaction-network
    depends_on:
      backend:
        condition: service_healthy

  # ============================================
  # Neo4j Graph Database (Optional)
  # ============================================
  neo4j:
    image: neo4j:5.16-community
    container_name: chainreaction-neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=${NEO4J_USERNAME:-neo4j}/${NEO4J_PASSWORD:-password}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - chainreaction-network

# ============================================
# Networks
# ============================================
networks:
  chainreaction-network:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  neo4j_data:
  neo4j_logs:
